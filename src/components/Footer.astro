---
import { Icon } from "astro-icon/components";
import { USER_NAME, USER_SITE, USER_FOOTER_SOCIAL_ICONS, SITE_ICP, SITE_ICP_LINK, SITE_POLICE_BEIAN, SITE_POLICE_BEIAN_LINK, GITHUB_CONFIG } from "@config";
import { getBuildInfo } from "@/lib/build-info";
import dayjs from "@utils/dayjs";

const owner = GITHUB_CONFIG?.owner || '';
const repo = GITHUB_CONFIG?.repo || '';
const buildInfo = getBuildInfo(owner, repo);
---

<footer class="footer bg-base-100 py-2 px-4 md:p-10 rounded-xl shadow-lg gap-y-2 md:gap-4">
  <aside>
    <svg
      width="32"
      height="32"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      fill-rule="evenodd"
      clip-rule="evenodd"
      class="fill-current md:w-[50px] md:h-[50px]"
      aria-label="Logo"
      role="img"
    >
      <path
        d="M22.672 15.226l-2.432.811.841 2.515c.33 1.019-.209 2.127-1.23 2.456-1.15.325-2.148-.321-2.463-1.226l-.84-2.518-5.013 1.677.84 2.517c.391 1.203-.434 2.542-1.831 2.542-.88 0-1.601-.564-1.86-1.314l-.842-2.516-2.431.809c-1.135.328-2.145-.317-2.463-1.229-.329-1.018.211-2.127 1.231-2.456l2.432-.809-1.621-4.823-2.432.808c-1.355.384-2.558-.59-2.558-1.839 0-.817.509-1.582 1.327-1.846l2.433-.809-.842-2.515c-.33-1.02.211-2.129 1.232-2.458 1.02-.329 2.13.209 2.461 1.229l.842 2.515 5.011-1.677-.839-2.517c-.403-1.238.484-2.553 1.843-2.553.819 0 1.585.509 1.85 1.326l.841 2.517 2.431-.81c1.02-.33 2.131.211 2.461 1.229.332 1.018-.21 2.126-1.23 2.456l-2.433.809 1.622 4.823 2.433-.809c1.242-.401 2.557.484 2.557 1.838 0 .819-.51 1.583-1.328 1.847m-8.992-6.428l-5.01 1.675 1.619 4.828 5.011-1.674-1.62-4.829z"
      ></path>
    </svg>
    <p class="text-xs md:text-base">
      Powered by <a href="https://github.com/Mahiro-Blog" target="_blank" class="font-bold">Mahiro - Blog</a>
      <br />
      Copyright ©
      <a href={USER_SITE} target="_blank" class="font-bold">{USER_NAME}</a>
      2025–{new Date().getFullYear()}
      <br />
      All rights reserved
    </p>
  </aside>
  <nav>
  <span class="footer-title text-xs md:text-sm">Social</span>

  {/* 社交按钮行 */}
  <div class="grid grid-flow-col gap-3 md:gap-4">
    {
      USER_FOOTER_SOCIAL_ICONS.map((icon) => {
        let href = icon.href;
        if (
          (icon.svg.includes('mail') ||
            (icon.svg.includes('at-line') && !icon.svg.includes('wechat'))) &&
          !href.startsWith('mailto:')
        ) {
          href = `mailto:${href}`;
        } else if (icon.svg.includes('qq') && /^\d+$/.test(href)) {
          href = `tencent://message/?uin=${href}&Site=&Menu=yes`;
        }
        return (
          <div class="tooltip" data-tip={icon.title}>
            <a href={href} aria-label={icon.ariaLabel}>
              <Icon name={icon.svg} class="text-xl md:text-xl" />
            </a>
          </div>
        );
      })
    }

    <div class="tooltip" data-tip="RSS Feed">
      <a href="/rss.xml" aria-label="RSS Feed">
        <Icon name="ri:rss-line" class="text-xl md:text-xl" />
      </a>
    </div>
  </div>

  {/* ICP 和公安备案信息 */}
  {(SITE_ICP || SITE_POLICE_BEIAN) && (
    <div class="mt-2 text-xs md:text-sm flex flex-col gap-1">
      {SITE_ICP && (
        <a
          href={SITE_ICP_LINK}
          target="_blank"
          rel="noopener"
          class="font-bold hover:text-primary transition-colors"
        >
          {SITE_ICP}
        </a>
      )}
      {SITE_POLICE_BEIAN && (
        <a
          href={SITE_POLICE_BEIAN_LINK}
          target="_blank"
          rel="noopener"
          class="font-bold hover:text-primary transition-colors flex items-center gap-1"
        >
          <Icon name="ri:shield-check-line" class="text-sm" />
          {SITE_POLICE_BEIAN}
        </a>
      )}
    </div>
  )}
</nav>
</footer>

<!-- 构建信息 -->
<div class="bg-base-100 rounded-xl shadow-lg mt-4 px-4 py-3">
  <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-base-content/50">
    <div class="flex items-center gap-3 flex-wrap">
      <span class="flex items-center gap-1">
        <Icon name="lucide:hash" class="w-3.5 h-3.5" />
        Build <span class="font-mono font-bold text-base-content/70">#{buildInfo.totalCommits}</span>
      </span>
      <span class="flex items-center gap-1">
        <Icon name="lucide:clock" class="w-3.5 h-3.5" />
        {buildInfo.buildTime}
      </span>
    </div>
    {buildInfo.commitSha && (
      <a
        href={buildInfo.commitUrl}
        target="_blank"
        rel="noopener"
        class="flex items-center gap-1 hover:text-primary transition-colors"
      >
        <Icon name="lucide:git-commit-horizontal" class="w-3.5 h-3.5" />
        <span class="font-mono font-bold">{buildInfo.commitShort}</span>
        <span class="hidden sm:inline max-w-[200px] truncate">{buildInfo.commitMessage}</span>
        <span class="hidden sm:inline">·</span>
        <span class="hidden sm:inline">{dayjs(buildInfo.commitDate).format("MM/DD HH:mm")}</span>
      </a>
    )}
  </div>
</div>
