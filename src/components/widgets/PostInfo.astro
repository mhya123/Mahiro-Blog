---  
import { Icon } from "astro-icon/components";  
import { t, umamiConfig } from "@config";  
import type { PostData } from "@interfaces/data";  
const { pubDate, badge, word, time, url, hideViews = false } = Astro.props as PostData & { url?: string, hideViews?: boolean };  
  
// 从 URL 中提取 slug  
const slug = url ? url.split('/').filter(Boolean).pop() : undefined;  
---  
  
<div class="flex flex-col sm:flex-row sm:justify-between gap-y-1 sm:gap-y-2 mb-2 sm:mb-4 text-[10px] sm:text-sm opacity-75">  
  <div class="flex flex-wrap items-center gap-x-2 sm:gap-x-4 gap-y-1 sm:gap-y-2">  
    {  
      pubDate && (  
        <span class="flex items-center gap-1">  
          <Icon name="lucide:calendar" class="h-4 w-4 flex-shrink-0" />  
          <span class="truncate">{pubDate}</span>  
        </span>  
      )  
    }  
    {  
      badge && (  
        <span class="flex flex-wrap items-center gap-1">  
          <Icon name="lucide:bookmark" class="h-4 w-4 flex-shrink-0" />  
          <span class="truncate">{badge}</span>  
        </span>  
      )  
    }  
  </div>  
  <div class="flex flex-wrap items-center gap-x-3 gap-y-1">  
    <div class="flex items-center gap-1">  
      <Icon name="lucide:book-open" class="h-4 w-4 flex-shrink-0" />  
      <span class="truncate"><span id={`info-word-${slug}`}>{word}</span> {t("label.wordCount")} · <span id={`info-time-${slug}`}>{time}</span> {t("label.readTime")}</span>  
    </div>  
    {!hideViews && slug && umamiConfig.enable && (  
      <>
        <div class="flex items-center gap-1">  
          <Icon name="lucide:eye" class="h-4 w-4 flex-shrink-0 text-primary" />  
          <span class="truncate" id={`page-views-${slug}`}>-</span>  
        </div>
        <div class="flex items-center gap-1">  
          <Icon name="lucide:user" class="h-4 w-4 flex-shrink-0 text-primary" />  
          <span class="truncate" id={`page-visitors-${slug}`}>-</span>  
        </div>
      </>
    )}  
  </div>  
</div>  
  
{!hideViews && slug && umamiConfig.enable && (  
  <script define:vars={{ slug, umamiConfig }} is:inline>
    // 数字跳动动画
    function _animNum(el, target, suffix, dur) {
      if (!el) return;
      var to = parseInt(target, 10);
      if (isNaN(to) || to === 0) { el.textContent = target + suffix; return; }
      var s = performance.now();
      function tick(now) {
        var p = Math.min((now - s) / dur, 1);
        var ease = 1 - Math.pow(1 - p, 3);
        el.textContent = Math.round(to * ease).toLocaleString() + suffix;
        if (p < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // 获取文章浏览量统计，支持 websiteId 或 shareId
    async function fetchPostViews() {
      if (!umamiConfig.enable) {
        return;
      }
      
      const checkInterval = setInterval(async () => {
        if (typeof window.fetchUmamiStats === 'function') {
          clearInterval(checkInterval);
          try {
            // RyuChan assumes blog posts are at /blog/slug
            // Adjust this path if your URL structure is different
            const queryPath = `/blog/${slug}`;
            
            const statsData = await window.fetchUmamiStats(umamiConfig.baseUrl, umamiConfig.shareId, {
              timezone: umamiConfig.timezone,
              path: queryPath
            });
            
            const pageViews = (typeof statsData.pageviews === 'object' ? statsData.pageviews.value : statsData.pageviews) || 0;
            const visits = (typeof statsData.visitors === 'object' ? statsData.visitors.value : statsData.visitors) || 0;
            
            const viewsElement = document.getElementById(`page-views-${slug}`);
            const visitorsElement = document.getElementById(`page-visitors-${slug}`);
            
            _animNum(viewsElement, pageViews, ' 次', 800);
            _animNum(visitorsElement, visits, ' 人', 800);
          } catch (error) {
            console.error('Error fetching page views for', slug, ':', error);
            const viewsElement = document.getElementById(`page-views-${slug}`);
            const visitorsElement = document.getElementById(`page-visitors-${slug}`);
            
            if (viewsElement) viewsElement.textContent = '-';
            if (visitorsElement) visitorsElement.textContent = '-';
          }
        }
      }, 100);

      // Stop checking after 10 seconds
      setTimeout(() => clearInterval(checkInterval), 10000);
    }
    
    // 页面加载完成后获取统计数据
    document.addEventListener('astro:page-load', fetchPostViews);
    // Initial run for direct loads (though astro:page-load covers it usually)
    if (document.readyState === 'complete') fetchPostViews();
    else document.addEventListener('DOMContentLoaded', fetchPostViews);
  </script>
)}

{slug && (
  <script define:vars={{ slug, word, time }} is:inline>
    (function() {
      var _done = '__animInfoWT_' + slug;
      function _animInfoWordTime() {
        if (window[_done]) return;
        window[_done] = true;
        function anim(el, target, dur) {
          if (!el) return;
          var to = parseInt(target, 10);
          if (isNaN(to) || to === 0) { el.textContent = String(target); return; }
          el.textContent = '0';
          var s = performance.now();
          function tick(now) {
            var p = Math.min((now - s) / dur, 1);
            var ease = 1 - Math.pow(1 - p, 3);
            el.textContent = String(Math.round(to * ease));
            if (p < 1) requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        }
        anim(document.getElementById('info-word-' + slug), word, 600);
        anim(document.getElementById('info-time-' + slug), time, 600);
      }
      document.addEventListener('astro:page-load', function() { window[_done] = false; _animInfoWordTime(); });
      if (document.readyState === 'complete') _animInfoWordTime();
      else document.addEventListener('DOMContentLoaded', _animInfoWordTime);
    })();
  </script>
)}