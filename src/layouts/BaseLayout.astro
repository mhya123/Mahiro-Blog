---
import {
  SITE_TAB,
  SITE_DESCRIPTION,
  SITE_FAVICON,
  SITE_LANGUAGE,
  SITE_THEME,
  umamiConfig,
  SITE_PAGES,
  DEFAULT_BANNER_MODE,
} from "@config";
import { ClientRouter } from "astro:transitions";
import ElementCrossing from "astro-vtbot/components/ElementCrossing.astro";
import PointerOnNavigation from "astro-vtbot/components/PointerOnNavigation.astro";
import Header from "@components/Header.astro";
import Sidebar from "@components/Sidebar.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import Banner from "@components/Banner.astro";
import MobileTOC from "@components/widgets/MobileTOC.astro";
import GlobalAudio from "@components/widgets/GlobalAudio.astro";
import CookieConsent from "@components/widgets/CookieConsent.astro";
import UpdateNotifier from "@components/widgets/UpdateNotifier";

const {
  title,
  image,
  headings = [],
  showTOC = false,
  isIndexed = true,
  isPostPage = false,
  showSidebar = true,
  showBanner = true,
} = Astro.props;

// 根据当前路径从配置中获取 Banner 内容
const currentPath = Astro.url.pathname.replace("/", "") || "home";
const pageConfig = SITE_PAGES?.[currentPath];
const bannerTitle = pageConfig?.title || title || "";
const bannerSubtitle = pageConfig?.subtitle || "";
---

<!doctype html>
<html
  lang={SITE_LANGUAGE}
  style="background-color: var(--custom-page-bg)"
  data-theme={SITE_THEME.light}
  data-theme-type="light"
>
  <head>
    <ClientRouter />
    <ElementCrossing />
    <PointerOnNavigation />
    <Header
      title={title}
      description={SITE_DESCRIPTION}
      favicon={SITE_FAVICON}
      image={image}
    />
    <title>{`${title} - ${SITE_TAB}`}</title>

    <!-- Google Fonts 预连接 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- 中文字体：异步加载，不阻塞渲染 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@400;700&family=LXGW+WenKai:wght@400;700&family=ZCOOL+XiaoWei&family=Ma+Shan+Zheng&family=Long+Cang&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+KuaiLe&family=Liu+Jian+Mao+Cao&family=Zhi+Mang+Xing&display=swap" media="print" onload="this.media='all'" />

    <!-- 字体初始化（防闪烁 FOUC）-->
    <script is:inline>
      (function() {
        var font = localStorage.getItem('blog-font');
        if (font) {
          var el = document.createElement('style');
          el.id = 'blog-font-override';
          el.textContent = 'html, body, *, *::before, *::after { font-family: ' + font + ' !important; }';
          document.head.appendChild(el);
        }
      })();
    </script>

    <!-- Umami分析（自建） -->
    {
      umamiConfig.enable && umamiConfig.websiteId && (
        <script
          is:inline
          defer
          src={`${umamiConfig.baseUrl}/script.js`}
          data-website-id={umamiConfig.websiteId}
        />
      )
    }
    {
      umamiConfig.enable && (
        <script is:inline defer src="/js/umami-share.js"></script>
      )
    }

    <!-- Microsoft Clarity -->
    <script type="text/javascript" is:inline>
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script", "skz108rus8");
    </script>

    <!-- 主题管理脚本 -->
    <script define:vars={{ SITE_THEME, DEFAULT_BANNER_MODE }} is:inline>
      (function () {
        const storedTheme = localStorage.getItem("theme");
        const storedBannerMode = localStorage.getItem("banner-mode") || DEFAULT_BANNER_MODE;
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        
        let theme;
        if (storedTheme) {
          theme = storedTheme;
        } else {
          theme = SITE_THEME.light;
          localStorage.setItem("theme", theme);
        }
        document.documentElement.setAttribute("data-theme", theme);
        document.documentElement.setAttribute("data-banner-mode", storedBannerMode);
        
        const isDark = theme === SITE_THEME.dark || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(theme);
        const themeType = isDark ? "dark" : "light";
        document.documentElement.setAttribute("data-theme-type", themeType);
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              const newTheme = e.matches ? SITE_THEME.dark : SITE_THEME.light;
              document.documentElement.setAttribute("data-theme", newTheme);
              const newThemeType = e.matches ? "dark" : "light";
              document.documentElement.setAttribute(
                "data-theme-type",
                newThemeType,
              );
              localStorage.setItem("theme", newTheme);
            }
          });
      })();
    </script>
  </head>

  <!-- 移除上边距，让Banner从顶部开始 -->
  <body
    transition:animate="fade"
    class="flex flex-col min-h-screen bg-[var(--banner-wave-bg)]"
    {...isIndexed ? { "data-pagefind-body": true } : {}}
  >
    {showBanner && <Banner title={bannerTitle} subtitle={bannerSubtitle} />}
    <Navbar />
    <div class={`max-w-blog mx-auto w-full flex-grow page-content-animate ${showBanner ? 'mt-8' : 'mt-24'}`}>
      <div
        class={`grid grid-cols-1 ${showSidebar ? "md:grid-cols-5 lg:grid-cols-4" : ""} gap-4 px-4 pb-4 h-full`}
      >
        <main
          class={`col-span-1 ${showSidebar ? "md:col-span-4 lg:col-span-3" : "w-full"} bg-transparent order-1 md:order-2 flex flex-col gap-4`}
        >
          <div class="flex-grow flex flex-col gap-4">
            <slot />
          </div>
          <Footer />
        </main>
        {
          showSidebar && (
            <aside class="col-span-1 bg-transparent order-2 md:order-1 md:top-4 hidden md:block">
              <Sidebar headings={headings} showTOC={showTOC} />
              <slot name="sidebar" />
            </aside>
          )
        }
      </div>
    </div>


    <MobileTOC headings={headings} showTOC={showTOC} />
    <GlobalAudio />
    <CookieConsent />
    <UpdateNotifier client:only="react" />

    <!-- 其余脚本保持不变 -->
    <script define:vars={{ SITE_THEME, DEFAULT_BANNER_MODE }} is:inline>
      document.addEventListener("astro:after-swap", () => {
        const storedTheme = localStorage.getItem("theme");
        const storedBannerMode = localStorage.getItem("banner-mode") || DEFAULT_BANNER_MODE;
        
        if (storedTheme) {
          document.documentElement.setAttribute("data-theme", storedTheme);
          const isDark = storedTheme === SITE_THEME.dark || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(storedTheme);
          const themeType = isDark ? "dark" : "light";
          document.documentElement.setAttribute("data-theme-type", themeType);
        }
        
        document.documentElement.setAttribute("data-banner-mode", storedBannerMode);
      });
    </script>

    <script is:inline>
      document.addEventListener("astro:page-load", () => {
        document.querySelectorAll(".btn-copy").forEach((button) => {
          button.addEventListener("click", async () => {
            const codeBlock = button.closest(".mahiro-code");
            const code = codeBlock.querySelector("code").textContent;
            const copyIcon = button.querySelector(
              ".mahiro-code-toolbar-copy-icon",
            );
            const successIcon = button.querySelector(
              ".mahiro-code-toolbar-copy-success",
            );
            try {
              await navigator.clipboard.writeText(code);
              copyIcon.classList.add("hidden");
              successIcon.classList.remove("hidden");
              button.classList.add("copy-success");
              setTimeout(() => {
                copyIcon.classList.remove("hidden");
                successIcon.classList.add("hidden");
                button.classList.remove("copy-success");
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
            }
          });
        });
      });
    </script>

    <style is:inline>
      .btn-copy {
        position: relative;
        overflow: hidden;
      }
      .copy-success {
        animation: pulse 0.5s ease-in-out;
      }
  .mahiro-code-toolbar-copy-success svg {
        color: #10b981;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </body>
</html>
