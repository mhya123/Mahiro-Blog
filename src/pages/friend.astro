---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import FriendCard from "@/components/mdx/FriendCard.astro";

// 使用 import.meta.glob 自动加载所有友链 JSON 文件
const friendModules = import.meta.glob<{ default: any }>('/src/data/friends/*.json', { eager: true });
const friends = Object.values(friendModules).map((mod) => mod.default);

// 友链 PR 申请链接：引导用户直接在仓库中新建 JSON 文件提交 PR
const applyUrl = `https://github.com/mhya123/Mahiro-Blog/new/main/src/data/friends?filename=你的名字.json&value=${encodeURIComponent(JSON.stringify({
  "name": "您的网站名",
  "avatar": "https://您的头像URL",
  "description": "您的网站描述",
  "url": "https://您的网站URL",
  "backlink": "https://您的友链页URL (选填，如果本站链接不在首页)",
  "badge": "友情链接"
}, null, 2))}`;

const issueTemplate = `### 友链申请 (WAF 拦截转审)

请严格按照下方 JSON 格式填写您的网站信息（不需要修改反引号,不需要更改标题）：
需要将: "您的网站名" , 修改为正确的网站名.
\`\`\`json
{
  "name": "您的网站名",
  "avatar": "https://您的头像URL",
  "description": "您的网站描述",
  "url": "https://您的网站URL",
  "backlink": "https://您的友链页URL (选填，如果本站链接不在首页)",
  "badge": "友情链接"
}
\`\`\`
`;
const issueUrl = `https://github.com/mhya123/Mahiro-Blog/issues/new?title=${encodeURIComponent("友链申请: 您的网站名")}&body=${encodeURIComponent(issueTemplate)}`;
---

<BaseLayout title="Friends" isIndexed={false}>
  <!-- Friends Section -->
  <div class="mb-10 animate-fade-in-up">
    <h1 class="text-3xl md:text-4xl font-bold mb-4 flex items-center gap-3">
      <Icon name="lucide:users" class="text-primary" />
      <span>Friends</span>
    </h1>
    <p class="text-base-content/70 text-lg mb-6">
      海内存知己，天涯若比邻。
    </p>
    
    {friends.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {friends.map((friend) => (
          <FriendCard
            name={friend.name}
            avatar={friend.avatar}
            description={friend.description}
            url={friend.url}
            badge={friend.badge}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-12 text-base-content/50">
        <Icon name="lucide:users" class="w-16 h-16 mx-auto mb-4 opacity-30" />
        <p class="text-lg">暂时还没有友链，快来申请成为第一个吧！</p>
      </div>
    )}
  </div>

  <!-- Divider -->
  <div class="divider my-8 animate-fade-in-up" style="animation-delay: 0.1s;">
    <Icon name="lucide:heart" class="w-12 h-12 text-primary/50" />
  </div>

  <!-- 友链申请区块 -->
  <div class="animate-fade-in-up" style="animation-delay: 0.2s;">
    <h2 class="text-2xl md:text-3xl font-bold mb-4 flex items-center gap-3">
      <Icon name="lucide:hand-metal" class="text-primary" />
      <span>友链申请</span>
    </h2>
    <p class="text-base-content/70 text-base mb-6">
      想要互换友链？只需在 GitHub 上提交一个 PR，机器人会自动审核并合并！
    </p>

    <!-- 申请信息卡片 -->
    <div class="bg-base-100 rounded-2xl border border-base-200 p-6 md:p-8 mb-6">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <Icon name="lucide:info" class="w-5 h-5 text-primary" />
        申请要求
      </h3>
      <ul class="space-y-3 text-base-content/80 text-sm">
        <li class="flex items-start gap-2">
          <Icon name="lucide:check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0" />
          <span>您的站点能够正常访问且有实质内容</span>
        </li>
        <li class="flex items-start gap-2">
          <Icon name="lucide:check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0" />
          <span>已在您的站点添加本站友链</span>
        </li>
        <li class="flex items-start gap-2">
          <Icon name="lucide:check-circle" class="w-4 h-4 text-green-500 mt-0.5 shrink-0" />
          <span>站点不包含违规/侵权内容</span>
        </li>
      </ul>

      <div class="divider my-4"></div>

      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <Icon name="lucide:link" class="w-5 h-5 text-primary" />
        本站信息
      </h3>
      <div class="bg-base-200/50 rounded-xl p-4 font-mono text-sm overflow-x-auto">
        <pre class="whitespace-pre text-base-content/80">{JSON.stringify({
  name: "Mahiro's Blog",
  avatar: "https://q.qlogo.cn/headimg_dl?dst_uin=1015000721&spec=640&img_type=jpg",
  description: "MhYa123的博客分享各类杂谈,技术,生活.",
  url: "https://www.mahiro.work",
  badge: "友情链接"
}, null, 2)}</pre>
      </div>
    </div>

    <!-- 提示 -->
    <div class="alert alert-warning mb-4 flex items-center gap-2 text-sm">
      <Icon name="lucide:alert-triangle" class="w-5 h-5 shrink-0" />
      <span><strong>不要忘了改文件名！</strong> 请将默认的 <code>你的名字.json</code> 改为您的站点名称，例如 <code>MhYa123.json</code>。</span>
    </div>

    <!-- WAF 拦截提示 -->
    <div class="alert alert-info mb-6 flex items-start gap-2 text-sm">
      <Icon name="lucide:info" class="w-5 h-5 shrink-0 mt-0.5" />
      <div>
        <strong>验证失败？</strong>
        <p class="mt-1">如果您的网站开启了 WAF（防火墙）拦截了无头浏览器或海外 IP 爬虫，导致 GitHub Actions 自动化验证失败，请直接前往 <a href={issueUrl} target="_blank" rel="noopener noreferrer" class="link font-bold">仓库提交 Issue 申请</a>，我们将进行人工审核。</p>
      </div>
    </div>

    <!-- 申请按钮 -->
    <div class="flex justify-center">
      <a
        href={applyUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-primary btn-lg gap-2 px-8 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5"
      >
        <Icon name="lucide:git-pull-request" class="w-5 h-5" />
        前往 GitHub 提交 PR 申请
      </a>
    </div>
  </div>
</BaseLayout>
